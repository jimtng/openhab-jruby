<!-- <!addon-only> -->
# openHAB JRuby Library

[![Gem Version](https://img.shields.io/gem/v/openhab-jrubyscripting)](https://rubygems.org/gems/openhab-jrubyscripting)
[![Continous Integration](https://github.com/ccutrer/openhab-jrubyscripting/workflows/Continuous%20Integration/badge.svg)](https://github.com/ccutrer/openhab-jrubyscripting/actions/workflows/ci.yml)
[![GitHub contributors](https://img.shields.io/github/contributors/ccutrer/openhab-jrubyscripting)](https://github.com/ccutrer/openhab-jrubyscripting/graphs/contributors)
[![EPLv2 License](https://img.shields.io/badge/License-EPLv2-blue.svg)](https://www.eclipse.org/legal/epl-2.0/)

This library aims to be a fairly high-level Ruby gem to support automation in openHAB.

<!-- </!addon-only> -->

<!-- This file is auto-generated by YARD from https://github.com/ccutrer/openhab-jrubyscripting/blob/main/README.md; please do not edit directly -->
<!-- To regenerate, run `ADDON=1 bin/yard display -f markdown -o https://ccutrer.github.io/openhab-jrubyscripting file:README.md -->

<!-- <addon-only>
# JRuby Scripting

This add-on provides [JRuby](https://www.jruby.org/) scripting language for automation rules.

Also included is [openhab-jrubyscripting](https://ccutrer.github.com/openhab-jrubyscripting/), a fairly high-level Ruby gem to support automation in openHAB.

It provides native Ruby access to common openHAB functionality within rules including items, things, actions, logging and more.
-->

<!-- <!yard-only> -->
Full documentation is available on [GitHub Pages](https://ccutrer.github.io/openhab-jrubyscripting/).
<!-- </!yard-only> -->

<!-- <!addon-only> -->
 * [Installation](docs/installation.md)
<!-- </!addon-only> -->
 * [Configuration](#Configuration)
 * [Usage](docs/usage.md)
 * [Examples](docs/examples.md)
   * [How Do I...?](docs/examples/how_do_i.md)
 * [Testing Your Rules](docs/testing.md)

<!-- -->

 * [Motivation](docs/motivation.md)
 * [Ruby Basics](docs/ruby-basics.md)

<!-- -->

 * [Changelog](CHANGELOG.md)
 * [Contributing](CONTRIBUTING.md)

## Configuration

After installing this add-on, you will find configuration options in the openHAB portal under _Settings -> Other Services -> JRuby Scripting_.
By default this add-on include the [openhab-jrubyscripting](https://github.com/cutrer/openhab-jrubyscripting/) Ruby gem and automatically `require`s it.
This allows the use of {OpenHAB::DSL.items items}, {OpenHAB::DSL.rules rules}, {OpenHAB::DSL.shared_cache shared_cache} and other objects in your scripts.
This functionality can be disabled for users who prefer to manage their own gems and `require`s via the add-on configuration options.
Simply change the `gems` and `require` configuration settings.

Alternatively, JRuby configuration parameters may be set by creating a `jruby.cfg` file in `conf/services/`

| Parameter                                             | Default                                                  | Description                                                                                                                                                                                                                                                                                               |
| ----------------------------------------------------- | -------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| org.openhab.automation.jrubyscripting:gem_home        | $OPENHAB_CONF/automation/ruby/.gem/{RUBY_ENGINE_VERSION} | Location Ruby Gems will be installed to and loaded from. Directory will be created if necessary. You can use `{RUBY_ENGINE_VERSION}`, `{RUBY_ENGINE}` and/or `{RUBY_VERSION}` replacements in this value to automatically point to a new directory when the addon is updated with a new version of JRuby. |
| org.openhab.automation.jrubyscripting:rubylib         | $OPENHAB_CONF/automation/ruby/lib                        | Search path for user libraries. Separate each path with a colon (semicolon in Windows).                                                                                                                                                                                                                   |
| org.openhab.automation.jrubyscripting:local_context   | singlethread                                             | The local context holds Ruby runtime, name-value pairs for sharing variables between Java and Ruby. See [this](https://github.com/jruby/jruby/wiki/RedBridge#Context_Instance_Type) for options and details                                                                                               |
| org.openhab.automation.jrubyscripting:local_variables | transient                                                | Defines how variables are shared between Ruby and Java. See [this](https://github.com/jruby/jruby/wiki/RedBridge#local-variable-behavior-options) for options and details                                                                                                                                 |
| org.openhab.automation.jrubyscripting:gems            | openhab-jrubyscripting=~>5.0.0                           | A comma separated list of [Ruby Gems](https://rubygems.org/) to install. The default installs the version of the helper for this version of openHAB.                                                                                                                                                      |
| org.openhab.automation.jrubyscripting:require         | openhab/dsl                                              | A comma separated list of script names to be required by the JRuby Scripting Engine at the beginning of user scripts. The default is to require the helper library.                                                                                                                                       |
| org.openhab.automation.jrubyscripting:check_update    | true                                                     | Check RubyGems for updates to the above gems when OpenHAB starts or JRuby settings are changed. Otherwise it will try to fulfil the requirements with locally installed gems, and you can manage them yourself with an external Ruby by setting the same GEM_HOME.                                        |

### UI Based Rules

The quickest way to add rules is through the openHAB Web UI.

Advanced users, or users migrating scripts from existing systems may want to use [File Based Rules](#file-based-rules) for managing rules using files in the user configuration directory.

#### Adding Triggers

Using the openHAB UI, first create a new rule and set a trigger condition.

![openHAB Rule Configuration](docs/rule-config.png)

#### Adding Actions

Select "Add Action" and then select "Run Script" with "Ruby".
This will bring up an empty script editor where you can enter your JavaScript.

![openHAB Rule Engines](docs/rule-engines.png)

You can now write rules using standard Ruby along with the included openHAB [standard library](#standard-library).

![openHAB Rule Script](docs/rule-script.png)

For example, turning a light on:

```ruby
KitchenLight.on
logger.info("Kitchen Light State: #{KitchenLight.state}")
```

Sending a notification:

```ruby
notify("romeo@montague.org", "Balcony door is open")
```

Querying the status of a thing:

```ruby
logger.info("Thing status: #{things["zwave:serial_zstick:512"].status}")"
```

See [openhab-jrubyscripting](https://ccutrer.github.io/openhab-jrubyscripting) for a complete list of functionality.

#### Event Object

When you use "Item event" as trigger (i.e. "[item] received a command", "[item] was updated", "[item] changed"), there is additional context available for the action in a variable called `event`.

This tables gives an overview of the `event` object for most common trigger types. For full details, explore {OpenHAB::Core::Events}.

| Property Name | Type                                         | Trigger Types                          | Description                                          | Rules DSL Equivalent   |
|---------------|----------------------------------------------|----------------------------------------|------------------------------------------------------|------------------------|
| `state`       | {OpenHAB::Core::Types::State State} or `nil` | `[item] changed`, `[item] was updated` | State that triggered event                           | `triggeringItem.state` |
| `was`         | {OpenHAB::Core::Types::State State} or `nil` | `[item] changed`                       | Previous state of Item or Group that triggered event | `previousState`        |
| `command`     | {OpenHAB::Core::Types::Command Command}      | `[item] received a command`            | Command that triggered event                         | `receivedCommand`      |
| `item`        | {OpenHAB::Core::Items::Item Item}            | all                                    | Item that triggered event                            | `triggeringItem`       |

```ruby
logger.info(event.state == ON)
```

## Scripting Basics

The openHAB JRuby Scripting runtime attempts to provide a familiar environment to Ruby developers.

### Gems

[Bundler](https://bundler.io/) is integrated, enabling any [Ruby gem](https://rubygems.org/) compatible with JRuby to be used within rules. This permits easy access to the vast ecosystem of libraries within the Ruby community.
Gems are available using the [inline bundler syntax](https://bundler.io/guides/bundler_in_a_single_file_ruby_script.html).
The require statement can be omitted. 

```ruby
gemfile do
  source 'https://rubygems.org'
  gem 'json', require: false
  gem 'nap', '1.1.0', require: 'rest'
end

logger.info("The nap gem is at version #{REST::VERSION}")
```

### Shared Code

If you would like to easily share code among multiple script, you can place it in `<OPENHAB_CONF>/automation/ruby/lib`.
You can then simply `require` the file from your rules files.
Files located in `$RUBYLIB` won't be automatically loaded individually by openHAB, only when you `require` them.

`automation/ruby/myrule.rb` OR a UI Rule's script:
```ruby
require "my_lib"

logger.info(my_lib_version)
```

`automation/ruby/lib/my_lib.rb`
```ruby
def my_lib_version
  "1.0"
end
```

### Logging

The JRuby Scripting addon has a global `logger` object for logging.

```text
log:set DEBUG org.openhab.automation.jrubyscripting.script
```

The default logger name for UI rules is `org.openhab.automation.jrubyscripting.script`.
For file-based rules, it's based on the rule's ID, such as `org.openhab.automation.jrubyscripting.rule.myrule.rb:15`
This can be changed by assigning a new logger locally.

Please be aware that messages might not appear in the logs if the logger name does not start with `org.openhab`.
This behaviour is due to [log4j2](https://logging.apache.org/log4j/2.x/) requiring definition for each logger prefix.

```ruby
logger = OpenHAB::Log.logger("org.openhab.custom")
```

The {OpenHAB::Logger logger} is similar to a standard [Ruby Logger](https://ruby-doc.org/stdlib-3.1.2/libdoc/logger/rdoc/Logger.html).
Supported logging functions include:

- `logger.log(severity, obj)`
- `logger.info(obj)`
- `logger.warn(obj)`
- `logger.error(obj)`
- `logger.debug(obj)`
- `logger.trace(obj)`

`obj` is any Ruby (or Java) object.
`#to_s` (or `toString()` if it's a Java object) is called on `obj`, and the result is output to the openHAB log.
Additionally, all of these methods can take a [Ruby block](https://ruby-doc.com/docs/ProgrammingRuby/html/tut_containers.html#S2) instead, which will only be called if logging is enabled at the given level, and the result of the block will be treated as the log message.

### Timers

```ruby
sleep 1.5 # sleep for 1.5 seconds
```

See Ruby docs on [sleep](https://ruby-doc.org/core-2.6/Kernel.html#method-i-sleep)

`sleep` should be avoided if possible. A {OpenHAB::DSL::Rules::BuilderDSL#delay delay} can be inserted in between two execution blocks to achieve the same result. This delay is implemented with a timer.
This is available only on file-based rules.

```ruby
rule 'delay something' do
  on_load
  run { logger.info 'This will run immediately' }
  delay 10.seconds
  run { logger.info 'This will run 10 seconds after' }
end
```

Alternatively a timer can be used in either a file-based rule or in a UI based rule using {OpenHAB::DSL.after after}.

```ruby
rule 'delay something' do
  on_load
  run do
    logger.info 'This will run immediately' 
    after(10.seconds) do
      logger.info 'This will run 10 seconds after'
    end
  end
end
```

When a script is unloaded, all created timers are automatically cancelled.

#### Accessing Variables

You can access all variables of the current context in the created timers.

Note: Variables can be mutated (changed) after the timer has been created.
Be aware that this can lead to unattended side effects, e.g. when you change the variable after timer creation, which can make debugging quite difficult!

```ruby
my_var = "Hello world!";

# Schedule a timer that expires in ten seconds
after(10.seconds) do
  logger.info("Timer expired with my_var = '#{my_var}'")
end

my_var = "Hello mutation!" # When the timer runs, it will log "Hello mutation!" instead of "Hello world!"
```

#### Reschedule a Timer

A timer can be rescheduled inside the timer body

```ruby
after(3.minutes) do |timer|
  My_Light.on
  timer.reschedule # This will reschedule it for the same initial duration, i.e. 3 minutes in this case
end
```

Or it can be rescheduled from outside the timer

```ruby
my_timer = after(3.minutes) do
  My_Light.on
end

my_timer.reschedule # Use the same initial duration
```

It can be rescheduled to a different duration

```ruby
after(3.minutes) do |timer|
  My_Light.on
  timer.reschedule(1.minute)
end
```

#### Manage Multiple Timers

Multiple timers can be managed in the traditional way by storing the timer objects in a Hash:

```ruby
@timers ||= {}

if @timers[event.item]
  @timers[event.item].reschedule 
else
  @timers[event.item] = after 3.minutes do # Use the triggering item as the timer ID
    event.item.off
    @timers.delete(event.item)
  end
end
```

However, a built in mechanism is available to help manage multiple timers, and is done in a thread-safe manner.
This is done using timer IDs.
The following rule automatically finds and reschedules the timer matching the same ID, which corresponds to each group member.

```ruby
after 3.minutes, id: event.item do # Use the triggering item as the timer ID
  event.item.off
end
```

Furthermore, you can manipulate the managed timers using the built-in {OpenHAB::DSL::TimerManager timers} object.

```ruby
# timers is a special object to access the timers created with an id
rule "cancel all timers" do
  received_command Cancel_All_Timers, to: ON # Send a command to this item to cancel all timers
  run do
    gOutdoorLights.members.each do |item_as_timer_id|
      timers.cancel(item_as_timer_id)
    end
  end
end

rule "reschedule all timers" do
  received_command Reschedule_All_Timers, to: ON # Send a command to this item to restart all timers
  run do
    gOutdoorLights.members.each do |item_as_timer_id|
      timers.reschedule(item_as_timer_id)
    end
  end
end
```


## Standard Library

Full documentation for the openHAB JRuby library can be found at {file:README.md openhab-jrubyscripting}.

### Items

The {OpenHAB::DSL.items items} object allows interactions with openHAB items.
However, most items can be referred to directly by name:

```ruby
My_Item
gWindowBlinds
```

Items can be retrieved dynamically:

```ruby
the_item = items['My_Item'] # This returns an Item object, not just its state
# For all intents and purposes, the_item variable is the same as My_Item in the previous example
```

Get the Item's Name as a String:

```ruby
My_Item.name
```

Get the Item's Label:

```ruby
My_Item.label
```

Get a Related Item:

```ruby
my_light_item = items[My_Switch.name.sub('_Switch', '_Light')]
```

#### Commands

These three variants do the same thing:

```ruby
My_Item.on
My_Item.command ON
My_Item << ON
```

Note: all possible commands are supported on the corresponding item types, e.g. `on`, `off`, `up`, `down`, `play`, `pause`, `stop`, etc. 
For more details, see the individual item classes under {OpenHAB::Core::Items}.

##### Sending Commands to an Item Only When Its State is Different

```ruby
My_Item.ensure.on
My_Item.ensure.command ON
My_Item.ensure << ON

# ensure causes the command to return nil if the item is already in the same state
logger.info("Turning off the light") if My_Item.ensure.off
```

##### Timed Commands

A {OpenHAB::DSL::Items::TimedCommand Timed Command} is similar to the openHAB Item's 
[expire parameter](https://www.openhab.org/docs/configuration/items.html#parameter-expire)
but it offers more flexibility. It removes the need to manually create a timer.

```ruby
My_Switch.on for: 5.minutes
```

#### Updates

Post an update to an item:

```ruby
My_Switch.update ON
```

#### State

The Item's state is accessible through {OpenHAB::Core::Item#state Item#state}:

```ruby
if My_Item.state == ON
  # do something
end

# This syntax is equivalent and preferred:
if My_Item.on?
  # do something
end

if Indoor_Temperature.state > 20 | '°C' || Indoor_Temperature.state > Outdoor_Temperature.state
  # do something
end
```

Note: Boolean helper methods are available depending on the item / state type.
For example `up?`, `down?`, `closed?`, `open?`, etc.

Check if an Item's state is {NULL} of {UNDEF}:

```ruby
if My_Item.state?
  logger.info 'My_Item is not NULL nor UNDEF'
end
```

#### Compare Item's State

```ruby
String_Item.state == 'test string'
Number_Item.state > 5.3
items['Number_Item'].state == 10

Temperature_Item.state > 24 | '°C'
Indoor_Temperature.state > Outdoor_Temperature.state 
Indoor_Temperature.state > Outdoor_Temperature.state + 5 | '°C'
Indoor_Temperature.state - Outdoor_Temperature.state > 5 | '°C'
```

### Metadata

Metadata is accessed through {OpenHAB::Core::Items::Item#metadata Item#metadata}.

```ruby
metadata = My_Item.metadata['namespace'].value
```

### Persistence

{OpenHAB::Core::Items::Persistence Persistence} methods are available directly on {OpenHAB::Core::Items::Item Items}.

```ruby
logger.info("KitchenDimmer average_since #{KitchenDimmer.average_since(1.day.ago)}")
daily_max = My_Item.maximum_since(24.hours.ago)
```

### Semantic Model

Many {Semantics helper methods} are available to make it easy to navigate the semantic model to get related items.

```ruby
LivingRoom_Motion.location                            # Location of the motion sensor
                 .equipments(Semantics::Lightbulb)    # Get all Lightbulb Equipments in the location
                 .members                             # Get all the member items of the equipments
                 .points(Semantics::Switch)           # Select only items that are Switch Points
                 .on                                  # Send an ON command to the items
```

### Item Builder

New items can be created via {OpenHAB::Core::Items::Registry#build items.build}.
Note that by default items are not persisted to storage, and will be removed when the script unloads.

```ruby
items.build do
  switch_item MySwitch, "My Switch"
  switch_item NotAutoupdating, autoupdate: false, channel: "mqtt:topic:1#light"
  group_item MyGroup do
    contact_item ItemInGroup, channel: "binding:thing#channel"
  end
  # passing `thing` to a group item will automatically use it as the base
  # for item channels
  group_item Equipment, tags: Semantics::HVAC, thing: "binding:thing"
    string_item Mode, tags: Semantics::Control, channel: "mode"
  end
end
```

### Things

The {OpenHAB::DSL.things things} object allows interactions with openHAB things.

Get Thing Status:

```ruby
things['lgwebos:WebOSTV:main-tv'].status
```

Check if Thing is Online:

```ruby
things['lgwebos:WebOSTV:main-tv'].online?
```

or

```ruby
things['lgwebos:WebOSTV:main-tv'].status == ThingStatus::ONLINE
```

Enable/Disable a Thing:

```ruby
thing = things['lgwebos:WebOSTV:main-tv']

thing.disable
logger.info "TV enabled: #{thing.enabled?}"

thing.enable
logger.info "TV enabled: #{thing.enabled?}"
```

### Actions

<!-- <!addon-only> -->

## Fork from [openhab-scripting](https://github.com/boc-tothefuture/openhab-jruby/)

This gem is a fork. Thanks to [@boc-tothefuture](https://github.com/boc-tothefuture), [@jimtng](https://github.com/jimtng), and [@pacive](https://github.com/pacive) on the original gem.
See [Changes from openhab-scripting](CHANGELOG.md#5_0_0) for more details on the reasoning behind the fork, and the significant breaking changes.

<!-- </!addon-only> -->

## Discussion

Please see [this thread](https://community.openhab.org/t/jruby-openhab-rules-system/110598) on the openHAB forum for further discussion.
Ideas and suggestions are welcome.

## Library Status

This is a beta and syntax and all elements are subject to change as the library
evolves.
